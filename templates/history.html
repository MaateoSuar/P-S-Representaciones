{% extends 'layout.html' %}
{% block content %}
<div class="bg-white rounded-lg shadow p-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold text-gray-800">Historial de Remitos</h2>
    <div class="flex items-center gap-3">
      <form method="get" action="{{ url_for('history') }}" class="relative">
        <input id="history-q" type="text" name="q" value="{{ q or '' }}" placeholder="Buscar cliente..." class="input-field pl-9 pr-3 py-2 rounded w-64" autocomplete="off" />
        <button type="submit" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500" title="Buscar">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z" />
          </svg>
        </button>
      </form>
      <a class="text-emerald-700" href="{{ url_for('products') }}">+ Nueva venta</a>
    </div>
  </div>

  <div id="history-results">
    {% if not orders %}
      <p class="text-gray-600">Aún no hay remitos generados.</p>
    {% else %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 table-striped">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nº</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Responsable</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Remito</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for o in orders %}
            <tr>
              <td class="px-4 py-2">{{ o.order_id }}</td>
              <td class="px-4 py-2">{{ o.created_display or '' }}</td>
              <td class="px-4 py-2">{{ o.client_name }}</td>
              <td class="px-4 py-2">{{ o.responsible or '—' }}</td>
              <td class="px-4 py-2 text-right">${{ '%.2f'|format(o.total) }}</td>
              <td class="px-4 py-2 text-right">
                {% if o.pdf_name %}
                  <a class="text-emerald-700" href="{{ url_for('download_remito', filename=o.pdf_name) }}">Descargar</a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="px-4 py-2 text-right">
                <a href="{{ url_for('history_to_cart', order_id=o.order_id) }}" class="text-emerald-700 hover:text-emerald-800 mr-3" title="Editar">Editar</a>
                <form method="post" action="{{ url_for('history_delete') }}" class="inline" data-confirm="¿Eliminar este remito? Esta acción no se puede deshacer.">
                  <input type="hidden" name="filename" value="{{ o.filename }}" />
                  <button type="submit" class="text-red-600 hover:text-red-700" title="Eliminar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block align-middle">
                      <path fill-rule="evenodd" d="M9 3.75A2.25 2.25 0 0 1 11.25 1.5h1.5A2.25 2.25 0 0 1 15 3.75V4.5h3.75a.75.75 0 0 1 0 1.5h-.51l-1.003 13.04A3.75 3.75 0 0 1 13.5 22.5h-3a3.75 3.75 0 0 1-3.737-3.46L5.76 6H5.25a.75.75 0 0 1 0-1.5H9V3.75Zm1.5.75h3V3.75a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0-.75.75V4.5Zm-2.992 1.5 1 13.03a2.25 2.25 0 0 0 2.242 2.12h3a2.25 2.25 0 0 0 2.242-2.12l1-13.03H7.508ZM9.75 9a.75.75 0 0 1 .75.75v8.25a.75.75 0 0 1-1.5 0V9.75a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
</div>
<script>
  (function(){
    const input = document.getElementById('history-q');
    const results = document.getElementById('history-results');
    if (!input || !results) return;
    let t;
    function bindConfirms(scope){
      (scope || document).querySelectorAll('form[data-confirm]').forEach(form => {
        form.addEventListener('submit', function(e){
          e.preventDefault();
          const msg = this.getAttribute('data-confirm') || '¿Seguro?';
          if (window.confirmAction) {
            window.confirmAction({ title: 'Confirmar', message: msg, okText: 'Sí, eliminar', okColor: 'red' }, ()=> this.submit());
          } else {
            if (confirm(msg)) this.submit();
          }
        });
      });
    }
    function debounceFetch(){
      clearTimeout(t);
      t = setTimeout(async () => {
        const q = input.value || '';
        try {
          const params = new URLSearchParams();
          if (q) params.set('q', q);
          const res = await fetch(`${location.pathname}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!res.ok) return;
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const newResults = doc.getElementById('history-results');
          if (newResults) {
            results.innerHTML = newResults.innerHTML;
            bindConfirms(results);
          }
        } catch(_) {}
      }, 200);
    }
    input.addEventListener('input', debounceFetch);
    // initial bind
    bindConfirms(results);
  })();
</script>
{% endblock %}
