{% extends 'layout.html' %}
{% block content %}
<div class="bg-white rounded-lg shadow p-4 mb-4 flex items-center justify-between">
  <h1 class="text-lg font-semibold text-gray-800">Dashboard</h1>
  <form method="get" action="{{ url_for('dashboard') }}" class="flex items-center gap-2">
    <label class="text-sm text-gray-600" for="days-top">Período:</label>
    <select id="days-top" name="days" class="input-field rounded px-2 py-1">
      {% for d in [7, 15, 30, 60, 90] %}
        <option value="{{ d }}" {% if (top_days or 30) == d %}selected{% endif %}>Últimos {{ d }} días</option>
      {% endfor %}
    </select>
    <button class="px-3 py-1.5 rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50" type="submit">Aplicar</button>
  </form>
</div>

<script>
  (function(){
    const sel = document.getElementById('days-top');
    const form = sel ? sel.closest('form') : null;
    if (sel && form) {
      sel.addEventListener('change', function(){ form.submit(); });
    }
  })();
</script>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <div class="bg-white rounded-lg shadow p-6 border-l-4 border-emerald-500">
    <p class="text-gray-500">Productos en Stock</p>
    <h3 class="text-2xl font-bold text-gray-800">{{ stats.productos }}</h3>
  </div>
  <div class="bg-white rounded-lg shadow p-6 border-l-4 border-emerald-500">
    <p class="text-gray-500">Clientes (últimos {{ top_days }} días)</p>
    <h3 class="text-2xl font-bold text-gray-800">{{ stats.clientes_periodo }}</h3>
  </div>
  <div class="bg-white rounded-lg shadow p-6 border-l-4 border-emerald-500">
    <p class="text-gray-500">Ventas (últimos {{ top_days }} días)</p>
    <h3 class="text-2xl font-bold text-gray-800">${{ '%.2f'|format(stats.ventas_periodo) }}</h3>
  </div>
  <div class="bg-white rounded-lg shadow p-6 border-l-4 border-emerald-500">
    <p class="text-gray-500">Margen promedio (últimos {{ top_days }} días)</p>
    <h3 class="text-2xl font-bold text-gray-800">{{ '%.1f'|format(stats.margen_prom_periodo) }}%</h3>
  </div>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-8">
  <h2 class="text-lg font-semibold text-gray-800 mb-4">Acciones rápidas</h2>
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
    <a href="{{ url_for('order_new') }}" class="px-4 py-3 rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50 text-center">Nuevo pedido</a>
    <a href="{{ url_for('cart_view') }}" class="px-4 py-3 rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50 text-center">Ver carrito</a>
    <a href="{{ url_for('clients_list') }}" class="px-4 py-3 rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50 text-center">Clientes</a>
    <a href="{{ url_for('history') }}" class="px-4 py-3 rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50 text-center">Historial</a>
    <a href="{{ url_for('pipeline_view') }}" class="px-4 py-3 rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50 text-center">Pipeline</a>
  </div>
  </div>

<div class="bg-white rounded-lg shadow p-6 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-gray-800">Ventas últimos {{ top_days }} días</h2>
  </div>
  <div class="h-64">
    <canvas id="salesChart"></canvas>
  </div>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-gray-800">Top 30 productos vendidos (últimos {{ top_days }} días)</h2>
  </div>
  {% if top_products and top_products|length > 0 %}
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 table-striped">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Cantidad</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for item in top_products %}
          <tr>
            <td class="px-4 py-2">{{ item.name }}</td>
            <td class="px-4 py-2 text-right">{{ '%.2f'|format(item.qty) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-gray-600">No hay ventas en el período seleccionado.</p>
  {% endif %}
</div>

<script id="sales-data" type="application/json">{{ {'labels': sales_labels, 'values': sales_values, 'clients': clients_values, 'margins': margin_values} | tojson }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const el = document.getElementById('salesChart');
    if (!el) return;
    let cfg = { labels: [], values: [], clients: [], margins: [] };
    try {
      const raw = document.getElementById('sales-data');
      if (raw) cfg = JSON.parse(raw.textContent || '{}');
    } catch(_) {}
    const labels = Array.isArray(cfg.labels) ? cfg.labels : [];
    const data = Array.isArray(cfg.values) ? cfg.values : [];
    const clients = Array.isArray(cfg.clients) ? cfg.clients : [];
    const margins = Array.isArray(cfg.margins) ? cfg.margins : [];
    new Chart(el, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Ventas',
          data,
          borderColor: '#059669',
          backgroundColor: 'rgba(5,150,105,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 2,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => {
                if (!items || !items.length) return '';
                return 'Día ' + items[0].label;
              },
              label: (ctx) => {
                const i = ctx.dataIndex;
                const venta = data[i] ?? 0;
                const cl = clients[i] ?? 0;
                const mg = margins[i] ?? 0;
                return [
                  `Ventas: $${venta.toFixed ? venta.toFixed(2) : venta}`,
                  `Clientes: ${cl}`,
                  `Margen: ${mg}%`
                ];
              }
            }
          }
        },
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { ticks: { maxTicksLimit: 10 } },
          y: { beginAtZero: false }
        }
      }
    });
  })();
</script>
{% endblock %}
