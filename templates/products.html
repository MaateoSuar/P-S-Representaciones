{% extends 'layout.html' %}
{% block content %}
<div class="bg-white rounded-lg shadow p-6">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg font-semibold text-gray-800">Productos</h2>
  </div>
  <div id="temp-alert" class="hidden fixed top-4 right-4 z-50 px-4 py-2 rounded bg-red-600 text-white shadow"></div>
  <form method="get" class="grid grid-cols-1 gap-3 mb-2" id="products-filter-form" onsubmit="return false;">
    <!-- Row 1: Client full width -->
    <div class="relative">
      <label class="block text-sm text-gray-600">Cliente</label>
      <div class="flex gap-2 items-center flex-nowrap">
        <input class="input-field flex-1 min-w-0 rounded px-3 py-2 h-[42px]" type="text" name="client" value="{{ current_client_name or client }}" placeholder="Escribir nombre del cliente" autocomplete="off" />
        <a href="{{ url_for('clients_new') }}" class="px-3 py-2 h-[42px] rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50 whitespace-nowrap">Crear cliente</a>
      </div>
      <div class="mt-1">
        <span id="client-active-pill" class="hidden inline-flex items-center px-2.5 py-1 rounded-full text-xs border border-emerald-200 bg-emerald-50 text-emerald-700 whitespace-nowrap">
          Cliente Activo: <span class="ml-1 font-medium">{{ current_client_name or '' }}</span>
        </span>
      </div>
      <div id="client-suggestions" class="absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg hidden max-h-56 overflow-auto">
        <!-- suggestions injected here -->
      </div>
      
    </div>
    <!-- Row 2: Buscar, Margen, Aplicar -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600">Buscar</label>
        <input class="input-field w-full rounded px-3 py-2 h-[42px]" type="text" name="q" value="{{ q }}" placeholder="Nombre del producto" autocomplete="off" />
      </div>
      <div class="flex items-end gap-2">
        <div>
          <label class="block text-sm text-gray-600">Margen %</label>
          <input class="input-field w-28 rounded px-3 py-2 h-[42px]" type="number" step="0.1" name="margin" value="{{ margin }}" />
        </div>
        <button id="apply-btn" class="btn-primary px-4 py-2 h-[42px] rounded" type="submit">Aplicar</button>
        <button id="export-pdf-btn" class="inline-flex items-center justify-center px-4 py-2 h-[42px] rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50" type="button">Exportar Catalogo</button>
      </div>
    </div>
  </form>
  

  <script id="clients-data" type="application/json">{{ (clients or [])|tojson }}</script>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 table-striped">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">P. Final</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">SubTotal</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Cant</th>
          <th class="px-4 py-2 text-right">
            <a href="{{ url_for('cart_view') }}" class="inline-flex items-center justify-center px-4 py-2 rounded border border-emerald-300 text-emerald-700 hover:bg-emerald-50">Ir al carrito</a>
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="products-body">
        {% for p in products %}
        <tr data-unit-price="{{ '%.2f'|format(p.final_price) }}">
          <td class="px-4 py-2">{{ p.name }}</td>
          <td class="px-4 py-2 text-right">{{ p.vencimiento and p.vencimiento.strip() or '-' }}</td>
          <td class="px-4 py-2 text-right">${{ '%.2f'|format(p.cost) }}</td>
          <td class="px-4 py-2 text-right">${{ '%.2f'|format(p.final_price) }}</td>
          <td class="px-4 py-2 text-right subtotal-cell">$0.00</td>
          <td class="px-4 py-2 text-center">
            <div class="inline-flex items-center border border-gray-300 rounded overflow-hidden">
              <button type="button" class="qty-minus px-2 h-[36px] text-gray-700 hover:bg-gray-100">−</button>
              <input class="qty-input w-16 px-2 py-1 h-[36px] text-center focus:outline-none" type="number" min="0" value="0" />
              <button type="button" class="qty-plus px-2 h-[36px] text-gray-700 hover:bg-gray-100">+</button>
            </div>
          </td>
          <td class="px-4 py-2 text-center">
            <form method="post" action="{{ url_for('cart_add') }}" onsubmit="return false;" class="row-add-form inline-flex items-center gap-2">
              <input type="hidden" name="id" value="{{ p.id }}" />
              <input type="hidden" name="margin" value="{{ margin }}" />
              <input type="hidden" name="ajax" value="1" />
              <button class="btn-primary inline-flex items-center justify-center px-3 py-1 h-[36px] rounded add-btn" type="button">Agregar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="mt-3 flex items-center justify-between" id="products-pagination" data-page="{{ page or 1 }}" data-per-page="{{ per_page or 20 }}" data-total-pages="{{ total_pages or 1 }}" data-total-count="{{ total_count or (products|length) }}">
    <div class="text-sm text-gray-600">
      Mostrando página <span id="pg-cur">{{ page or 1 }}</span> de <span id="pg-total">{{ total_pages or 1 }}</span> — <span id="pg-count">{{ total_count or (products|length) }}</span> productos
    </div>
    <div class="flex items-center gap-2">
      <button type="button" id="pg-prev" class="px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50">Anterior</button>
      <button type="button" id="pg-next" class="px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50">Siguiente</button>
      <select id="pg-size" class="ml-2 input-field rounded px-2 py-1 h-[34px]">
        {% for opt in [20,50,100,200] %}
        <option value="{{ opt }}" {% if (per_page or 20) == opt %}selected{% endif %}>{{ opt }}/página</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>
<script>
  (function(){
    const form = document.getElementById('products-filter-form');
    if (!form) return;
    const qInput = form.querySelector('input[name="q"]');
    const marginInput = form.querySelector('input[name="margin"]');
    const clientInput = form.querySelector('input[name="client"]');
    const tbody = document.getElementById('products-body');
    const cartAddUrl = "{{ url_for('cart_add') }}";
    const navBadge = document.getElementById('nav-cart-badge');
    const pagBox = document.getElementById('products-pagination');
    const btnPrev = document.getElementById('pg-prev');
    const btnNext = document.getElementById('pg-next');
    const selSize = document.getElementById('pg-size');
    const lblCur = document.getElementById('pg-cur');
    const lblTot = document.getElementById('pg-total');
    const lblCount = document.getElementById('pg-count');
    let timer;
    let allClients = [];
    try {
      const el = document.getElementById('clients-data');
      allClients = JSON.parse(el ? el.textContent : '[]');
    } catch(_) { allClients = []; }
    const suggBox = document.getElementById('client-suggestions');
    let suggMatches = [];
    let suggIndex = -1;

    function isValidClientName(raw){
      const name = (raw||'').trim().toLowerCase();
      if (!name) return false; // require selecting a client
      return (allClients||[]).some(c => (c&&c.name?c.name:'').trim().toLowerCase() === name);
    }
    function bumpClientInput(){
      if (!clientInput) return;
      clientInput.classList.add('ring-2','ring-red-400');
      setTimeout(()=> clientInput.classList.remove('ring-2','ring-red-400'), 600);
    }
    function showTempAlert(msg){
      const box = document.getElementById('temp-alert');
      if (!box) return;
      box.textContent = msg || '';
      box.classList.remove('hidden');
      clearTimeout(box._t);
      box._t = setTimeout(()=> box.classList.add('hidden'), 3000);
    }

    // Pagination state
    let currentPage = pagBox ? parseInt(pagBox.getAttribute('data-page') || '1', 10) : 1;
    let perPage = pagBox ? parseInt(pagBox.getAttribute('data-per-page') || '20', 10) : 20;
    let totalPages = pagBox ? parseInt(pagBox.getAttribute('data-total-pages') || '1', 10) : 1;
    let totalCount = pagBox ? parseInt(pagBox.getAttribute('data-total-count') || '0', 10) : 0;
    function updatePaginationUI(){
      if (!pagBox) return;
      if (lblCur) lblCur.textContent = String(currentPage);
      if (lblTot) lblTot.textContent = String(totalPages);
      if (lblCount) lblCount.textContent = String(totalCount);
      if (btnPrev) btnPrev.disabled = currentPage <= 1;
      if (btnNext) btnNext.disabled = currentPage >= totalPages;
      if (selSize && parseInt(selSize.value, 10) !== perPage) {
        selSize.value = String(perPage);
      }
    }
    updatePaginationUI();

    let fetchReason = 'search'; // 'search' | 'apply'
    async function fetchAndRender(){
      const params = new URLSearchParams({ q: qInput.value || '' });
      params.set('page', String(currentPage));
      params.set('per_page', String(perPage));
      if (fetchReason === 'apply') {
        params.set('margin', marginInput.value || '');
        params.set('client', clientInput.value || '');
      }
      try {
        const res = await fetch(`/api/products?${params.toString()}`, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) return;
        const data = await res.json();
        // Update cart badge if provided
        if (typeof data.cart_count !== 'undefined') {
          const count = data.cart_count;
          if (navBadge) {
            navBadge.textContent = count;
            if (count > 0) {
              navBadge.className = 'absolute -top-1 -right-1 inline-flex items-center justify-center text-[11px] font-medium w-5 h-5 rounded-full bg-emerald-600 text-white shadow ring-2 ring-white';
            } else {
              navBadge.className = 'hidden';
            }
          }
        }
        // Update margin only when applying
        if (fetchReason === 'apply' && typeof data.margin !== 'undefined' && data.margin !== null) {
          marginInput.value = data.margin;
        }
        
        // Update small pill only on apply
        if (fetchReason === 'apply') {
          const pill = document.getElementById('client-active-pill');
          const name = (data.current_client_name || clientInput.value || '').trim();
          if (pill) {
            if (name) {
              pill.classList.remove('hidden');
              pill.querySelector('span').textContent = name;
            } else {
              pill.classList.add('hidden');
            }
          }
        }
        // Update pagination from response
        if (typeof data.page !== 'undefined') currentPage = parseInt(data.page, 10) || 1;
        if (typeof data.per_page !== 'undefined') perPage = parseInt(data.per_page, 10) || perPage;
        if (typeof data.total_pages !== 'undefined') totalPages = parseInt(data.total_pages, 10) || 1;
        if (typeof data.total_count !== 'undefined') totalCount = parseInt(data.total_count, 10) || 0;
        updatePaginationUI();

        const rows = (data.products || []).map(p => `
          <tr data-unit-price="${Number(p.final_price ?? 0).toFixed(2)}">
            <td class="px-4 py-2">${escapeHtml(p.name ?? '')}</td>
            <td class="px-4 py-2 text-right">${(() => { const v=(p.vencimiento ?? '').trim(); return v?escapeHtml(v):'-'; })()}</td>
            <td class="px-4 py-2 text-right">$${Number(p.cost ?? 0).toFixed(2)}</td>
            <td class="px-4 py-2 text-right">$${Number(p.final_price ?? 0).toFixed(2)}</td>
            <td class="px-4 py-2 text-right subtotal-cell">$0.00</td>
            <td class="px-4 py-2 text-center">
              <div class="inline-flex items-center border border-gray-300 rounded overflow-hidden">
                <button type="button" class="qty-minus px-2 h-[36px] text-gray-700 hover:bg-gray-100">−</button>
                <input class="qty-input w-16 px-2 py-1 h-[36px] text-center focus:outline-none" type="number" min="0" value="0" />
                <button type="button" class="qty-plus px-2 h-[36px] text-gray-700 hover:bg-gray-100">+</button>
              </div>
            </td>
            <td class="px-4 py-2 text-center">
              <form method="post" action="${cartAddUrl}" class="row-add-form inline-flex items-center gap-2">
                <input type="hidden" name="id" value="${p.id}" />
                <input type="hidden" name="margin" value="${marginInput.value}" />
                <input type="hidden" name="ajax" value="1" />
                <button class="btn-primary inline-flex items-center justify-center px-3 py-1 h-[36px] rounded add-btn" type="button">Agregar</button>
              </form>
            </td>
          </tr>`).join('');
        tbody.innerHTML = rows || '<tr><td class="px-4 py-4 text-center text-gray-500" colspan="7">Sin resultados</td></tr>';
        bindRowForms();
      } catch (e) {
        // opcional: mostrar error
      }
    }

    // Set active client in session and update margin/labels without repainting table
    async function setActiveClient(forcedName){
      const raw = (forcedName != null ? forcedName : clientInput.value) || '';
      const name = raw.trim();
      if (!name) return;
      try {
        const params = new URLSearchParams({ client: name });
        const res = await fetch(`/api/products?${params.toString()}`, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) return;
        const data = await res.json();
        // Update cart badge if client change cleared cart
        if (typeof data.cart_count !== 'undefined') {
          const count = data.cart_count;
          if (navBadge) {
            navBadge.textContent = count;
            if (count > 0) {
              navBadge.className = 'absolute -top-1 -right-1 inline-flex items-center justify-center text-[11px] font-medium w-5 h-5 rounded-full bg-emerald-600 text-white shadow ring-2 ring-white';
            } else {
              navBadge.className = 'hidden';
            }
          }
        }
        if (typeof data.margin !== 'undefined' && data.margin !== null) {
          marginInput.value = data.margin;
        }
        
        const pill = document.getElementById('client-active-pill');
        if (pill) {
          if (name) {
            pill.classList.remove('hidden');
            pill.querySelector('span').textContent = name;
          } else {
            pill.classList.add('hidden');
          }
        }
        // normalize input to resolved name (proper casing)
        if (!forcedName && data.current_client_name) clientInput.value = data.current_client_name;
      } catch(_) {}
    }

    function debounceFetch(){
      clearTimeout(timer);
      timer = setTimeout(fetchAndRender, 200);
    }

    // Simple HTML escape to avoid injecting raw values
    function escapeHtml(str){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    qInput.addEventListener('input', () => { fetchReason='search'; currentPage = 1; debounceFetch(); });
    // Do not auto-fetch on margin or client typing; suggestions only
    clientInput.addEventListener('input', () => {
      // build pretty suggestions only; do not auto-activate client here
      const q = (clientInput.value || '').trim().toLowerCase();
      if (!q) { suggBox.classList.add('hidden'); suggBox.innerHTML=''; return; }
      buildSuggestions(q);
      // will apply only on Enter or Apply
    });
    clientInput.addEventListener('change', () => {
      const typed = (clientInput.value || '').trim().toLowerCase();
      if (!typed) return;
      const exact = (allClients || []).find(c => (c && c.name ? c.name : '').toLowerCase() === typed);
      if (exact) {
        setActiveClient(exact.name);
      }
      // If not exact, do not auto-apply to avoid reverting to previous client
    });
    // Do not auto-apply on blur to avoid reverting to previous client
    // Apply button (form submit)
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      // Block if client typed does not exist
      const typed = clientInput ? (clientInput.value||'') : '';
      if (typed && !isValidClientName(typed)) { bumpClientInput(); showTempAlert('Agregue un Cliente registrado'); return; }
      fetchReason='apply'; currentPage = 1; fetchAndRender();
    });
    const applyBtn = document.getElementById('apply-btn');
    if (applyBtn) applyBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const typed = clientInput ? (clientInput.value||'') : '';
      if (typed && !isValidClientName(typed)) { bumpClientInput(); showTempAlert('Agregue un Cliente registrado'); return; }
      fetchReason='apply'; currentPage = 1; fetchAndRender();
    });
    const exportBtn = document.getElementById('export-pdf-btn');
    if (exportBtn) exportBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      const params = new URLSearchParams();
      const qv = qInput && qInput.value ? qInput.value.trim() : '';
      const mv = marginInput && marginInput.value ? marginInput.value : '';
      if (qv) params.set('q', qv);
      if (mv !== '') params.set('margin', mv);
      window.location.href = `/products/export-pdf?${params.toString()}`;
    });
    // Do not repaint table on client change automatically
    function renderSuggestions() {
      if (!suggMatches.length) { suggBox.classList.add('hidden'); suggBox.innerHTML=''; return; }
      suggBox.innerHTML = suggMatches.map((n, i) => `
        <button type="button" data-index="${i}" class="sugg-item w-full text-left px-3 py-2 ${i===suggIndex ? 'bg-emerald-100' : 'hover:bg-emerald-50'}">
          <div class="text-sm text-gray-800">${escapeHtml(n)}</div>
        </button>
      `).join('');
      Array.from(suggBox.querySelectorAll('.sugg-item')).forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.getAttribute('data-index'));
          if (!isNaN(idx)) applySuggestion(idx);
        });
      });
      suggBox.classList.remove('hidden');
    }

    function buildSuggestions(q){
      suggIndex = -1;
      suggMatches = allClients
        .map(c => c && c.name ? c.name : '')
        .filter(n => n && n.toLowerCase().includes(q))
        .slice(0, 8);
      renderSuggestions();
    }

    function applySuggestion(idx){
      if (idx < 0 || idx >= suggMatches.length) return;
      clientInput.value = suggMatches[idx];
      suggBox.classList.add('hidden');
      // Immediately set active client (session/margin/labels), do not repaint table yet
      setActiveClient();
    }

    

    clientInput.addEventListener('keydown', (e) => {
      // Navigate suggestions
      if (!suggBox.classList.contains('hidden') && e.key === 'ArrowDown') {
        e.preventDefault();
        suggIndex = (suggIndex + 1) % suggMatches.length;
        renderSuggestions();
        return;
      }
      if (!suggBox.classList.contains('hidden') && e.key === 'ArrowUp') {
        e.preventDefault();
        suggIndex = (suggIndex - 1 + suggMatches.length) % suggMatches.length;
        renderSuggestions();
        return;
      }
      if (e.key === 'Enter') {
        // On Enter: activate best match without repainting
        e.preventDefault();
        if (!suggBox.classList.contains('hidden') && suggIndex >= 0) {
          applySuggestion(suggIndex);
        } else {
          const q = (clientInput.value || '').trim().toLowerCase();
          if (q) {
            const exact = (allClients || []).find(c => (c && c.name ? c.name : '').toLowerCase() === q);
            if (exact) {
              setActiveClient(exact.name);
            } else {
              const candidates = (allClients || []).map(c=>c&&c.name?c.name:'').filter(n=> n && n.toLowerCase().includes(q));
              if (candidates.length > 0) setActiveClient(candidates[0]);
            }
          }
        }
      } else if (e.key === 'Escape') {
        suggBox.classList.add('hidden');
      }
    });
    document.addEventListener('click', (e) => {
      if (!suggBox.contains(e.target) && e.target !== clientInput) {
        suggBox.classList.add('hidden');
      }
    });

    function bindRowForms(){
      // stepper handlers
      document.querySelectorAll('.row-add-form').forEach(formEl => {
        const row = formEl.closest('tr');
        const minus = row ? row.querySelector('.qty-minus') : null;
        const plus = row ? row.querySelector('.qty-plus') : null;
        const input = row ? row.querySelector('.qty-input') : null;
        const subtotalCell = row ? row.querySelector('.subtotal-cell') : null;
        const unit = row ? parseFloat(row.getAttribute('data-unit-price') || '0') : 0;
        const updateSubtotal = () => {
          if (!subtotalCell || !input) return;
          const qty = Math.max(0, parseInt(input.value || '0', 10));
          subtotalCell.textContent = '$' + (unit * qty).toFixed(2);
        };
        if (minus && input) minus.addEventListener('click', () => {
          const val = Math.max(0, parseInt(input.value || '0', 10) - 1);
          input.value = String(val);
          updateSubtotal();
        });
        if (plus && input) plus.addEventListener('click', () => {
          const val = Math.max(0, parseInt(input.value || '0', 10) + 1);
          input.value = String(val);
          updateSubtotal();
        });
        if (input) input.addEventListener('input', updateSubtotal);
        // initialize subtotal display
        updateSubtotal();
      });
      document.querySelectorAll('.row-add-form .add-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const formEl = btn.closest('form');
          if (!formEl) return;
          const row = formEl.closest('tr');
          const qtyEl = row ? row.querySelector('.qty-input') : null;
          const subtotalCell = row ? row.querySelector('.subtotal-cell') : null;
          const qty = parseInt(qtyEl && qtyEl.value ? qtyEl.value : '0', 10);
          if (!qty || qty < 1) { btn.classList.add('ring-2','ring-red-400'); setTimeout(()=>btn.classList.remove('ring-2','ring-red-400'), 400); return; }
          // Ensure client typed manually is set active before adding
          try {
            const typed = (clientInput && clientInput.value ? clientInput.value.trim() : '');
            // Block add if no client or client does not exist
            if (!typed || !isValidClientName(typed)) { bumpClientInput(); showTempAlert('Agregue un Cliente registrado'); return; }
            await setActiveClient(typed);
          } catch(_) {}
          const formData = new FormData(formEl);
          formData.set('qty', String(qty));
          try {
            const res = await fetch(cartAddUrl, { method: 'POST', body: formData, headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } });
            if (res.ok) {
              const data = await res.json();
              if (data && typeof data.cart_count !== 'undefined') {
                if (navBadge) {
                  const count = data.cart_count;
                  navBadge.textContent = count;
                  if (count > 0) {
                    // Apply full badge styling exactly as in layout when there are items
                    navBadge.className = 'absolute -top-1 -right-1 inline-flex items-center justify-center text-[11px] font-medium w-5 h-5 rounded-full bg-emerald-600 text-white shadow ring-2 ring-white';
                    // subtle bounce animation
                    navBadge.classList.add('animate-bounce');
                    setTimeout(()=> navBadge.classList.remove('animate-bounce'), 600);
                  } else {
                    // Hide when no items
                    navBadge.className = 'hidden';
                  }
                }
              }
              // reset qty to 0 after adding
              if (qtyEl) qtyEl.value = '0';
              if (subtotalCell) subtotalCell.textContent = '$0.00';
            }
          } catch(_) {}
        });
      });
    }

    // initial bind for server-rendered rows
    bindRowForms();

    // Pagination controls
    if (btnPrev) btnPrev.addEventListener('click', () => {
      if (currentPage > 1) { currentPage -= 1; fetchReason='search'; fetchAndRender(); }
    });
    if (btnNext) btnNext.addEventListener('click', () => {
      if (currentPage < totalPages) { currentPage += 1; fetchReason='search'; fetchAndRender(); }
    });
    if (selSize) selSize.addEventListener('change', () => {
      const val = parseInt(selSize.value, 10);
      if (!isNaN(val) && val > 0) {
        perPage = val;
        currentPage = 1;
        fetchReason='search';
        fetchAndRender();
      }
    });
  })();
</script>
{% endblock %}

